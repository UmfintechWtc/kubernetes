[program:kube-apiserver]
process_name = %(program_name)s
command={{ k8s_master_bin_path }}/kube-apiserver
  --advertise-address={{ ansible_host }}
  --allow-privileged=true
  --apiserver-count={{ groups['k8s_master'] | length }}
  --audit-log-maxage=30
  --audit-log-maxsize=100
  --audit-log-maxbackup=3
  --audit-log-path={{ k8s_master_logs_path }}/apiserver/k8s-audit.log
  --audit-policy-file={{ k8s_master_cfg_path }}/audit-policy.yaml
  --authorization-mode=Node,RBAC
  --bind-address={{ ansible_host }}
  --client-ca-file={{ k8s_master_ssl_path }}/ca.pem
  --delete-collection-workers=2
  --enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota
  --token-auth-file={{ k8s_master_cfg_path }}/token.csv
  --etcd-cafile={{ etcd_ssl_path }}/ca.pem
  --etcd-certfile={{ etcd_ssl_path }}/etcd.pem
  --etcd-keyfile={{ etcd_ssl_path }}/etcd-key.pem
  --etcd-servers={% for host in groups['etcd'] %}https://{{ hostvars[host]['ansible_host'] }}:2379{% if not loop.last %},{% endif %}{% endfor %}
  --event-ttl=72h
  --feature-gates=EphemeralContainers=true
  --kubelet-certificate-authority={{ k8s_master_ssl_path }}/ca.pem
  --kubelet-client-certificate={{ k8s_master_ssl_path }}/apiserver.pem
  --kubelet-client-key={{ k8s_master_ssl_path }}/apiserver-key.pem
  --proxy-client-cert-file={{ k8s_master_ssl_path }}/apiserver.pem
  --proxy-client-key-file={{ k8s_master_ssl_path }}/apiserver-key.pem
  --requestheader-client-ca-file={{ k8s_master_ssl_path }}/ca.pem
  --requestheader-allowed-names="aggregator"
  --requestheader-username-headers="X-Remote-User"
  --requestheader-group-headers="X-Remote-Group"
  --requestheader-extra-headers-prefix="X-Remote-Extra-"
  --runtime-config=api/all=true
  --secure-port={{ apiserver_port }}
  --service-account-issuer=https://kubernetes.default.svc.cluster.local
  --service-account-key-file={{ k8s_master_ssl_path }}/apiserver.pem
  --service-account-signing-key-file={{ k8s_master_ssl_path }}/apiserver-key.pem
  --service-cluster-ip-range=10.0.0.0/16
  --service-node-port-range=30000-50000
  --tls-cert-file={{ k8s_master_ssl_path }}/apiserver.pem
  --tls-private-key-file={{ k8s_master_ssl_path }}/apiserver-key.pem
  --enable-bootstrap-token-auth
directory={{ k8s_master_path }}
user= {{ app.user }}
startsecs=3
autostart = true
autorestart = true
stopwaitsecs = 360
stopsignal = KILL
stopasgroup = true
stdout_logfile = {{ k8s_master_logs_path }}/apiserver/%(program_name)s-stdout.log
stdout_logfile_maxbytes=100MB
stdout_logfile_backups=5
stderr_logfile = {{ k8s_master_logs_path }}/apiserver/%(program_name)s-stderr.log
stderr_logfile_maxbytes=100MB
stderr_logfile_backups=5